<!DOCTYPE html>
<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="initial-scale=1.0" />

<style type="text/css">.koka .plaincode, .koka a.pp .pc { display: none; } .koka a.pp { color: inherit; text-decoration: none; }</style>
<link rel="stylesheet" type="text/css" href="styles/koka.css" />

<link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Nunito:400,400italic,700,700italic" />
<link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto+Mono:400,500,700,400italic" />

<title>delayed.kk documentation</title>
</head>

<body class="koka doc body madoko">
<pre class="koka source"><span class="comment">/&#42;---------------------------------------------------------------------------
  Copyright 2023-2024, Microsoft Research, Daan Leijen.

  This is free software; you can redistribute it and/or modify it under the
  terms of the Apache License, Version 2.0. A copy of the License can be
  found in the LICENSE file at the root of this distribution.
---------------------------------------------------------------------------&#42;/</span>

<span class="comment">// Delayed computations.
</span><span class="kw">module</span> <a class="pp" href="std_core_delayed.html#_null_"><span class="mo">std/core/delayed</span><span class="pc"><span class="mo">std<span class="fslash">/</span>core<span class="fslash">/</span>delayed</span></span></a>

<span class="kw">import</span> <a class="pp" href="std_core_types.html#_null_"><span class="mo">std/core/types</span><span class="pc"><span class="mo">std<span class="fslash">/</span>core<span class="fslash">/</span>types</span></span></a>
<span class="kw">import</span> <a class="pp" href="std_core_hnd.html#_null_"><span class="mo">std/core/hnd</span><span class="pc"><span class="mo">std<span class="fslash">/</span>core<span class="fslash">/</span>hnd</span></span></a>
<span class="kw">import</span> <a class="pp" href="std_core_unsafe.html#_null_"><span class="mo">std/core/unsafe</span><span class="pc"><span class="mo">std<span class="fslash">/</span>core<span class="fslash">/</span>unsafe</span></span></a>

<span class="comment">// ----------------------------------------------------------------------------
// Delayed values
// ----------------------------------------------------------------------------
</span>
<span class="comment">// Delayed (or &#95;lazy&#95;) values are computed (with effect &#96;:e&#96;) only the first time
// &#96;force&#96; is called and cached afterwards.
</span><span class="decl-value type" id="type_space_delayed"><span class="kw">abstract</span> <span class="kw">value</span> <span class="tp kw">type</span> <a class="pp" href="std_core_delayed.html#type_space_delayed"><span class="tp">delayed</span><span class="pc"><span class="mo">std<span class="fslash">/</span>core<span class="fslash">/</span>delayed<span class="fslash last">/</span></span>delayed: <span class="tp sp">(</span><span class="co">E</span>, <span class="co">V</span>) <span class="kw op">-></span> <span class="co">V</span></span></a><span class="tp sp">&lt;</span><a class="pp"><span class="tp"><span class="effect">e</span></span><span class="pc">e: <span class="co">E</span></span></a><span class="tp sp">,</span><a class="pp"><span class="tp">a</span><span class="pc">a: <span class="co">V</span></span></a><span class="tp sp">&gt;</span>
  <span class="decl-con" id="con_space_XDelay"><span class="kw">con</span> <a class="pp" href="std_core_delayed.html#con_space_XDelay"><span class="co">XDelay</span><span class="pc"><span class="mo">std<span class="fslash">/</span>core<span class="fslash">/</span>delayed<span class="fslash last">/</span></span>XDelay: <span class="tp kw">forall</span><span class="tp sp">&lt;</span><span class="tp tv">e</span><span class="tp sp">,</span><span class="tp tv">a</span><span class="tp sp">&gt;</span> <span class="tp sp">(</span><span class="tp tpp">dref</span> <span class="tp kw op">:</span> <span class="tp">ref</span><span class="tp sp">&lt;</span><span class="tp">global</span><span class="tp sp">,</span><span class="tp">either</span><span class="tp sp">&lt;</span><span class="tp sp">(</span><span class="tp sp">)</span> <span class="tp kw op">-></span> <span class="tp tv">e</span> <span class="tp tv">a</span><span class="tp sp">,</span><span class="tp tv">a</span><span class="tp sp">&gt;</span><span class="tp sp">&gt;</span><span class="tp sp">)</span> <span class="tp kw op">-></span> <span class="tp">delayed</span><span class="tp sp">&lt;</span><span class="tp tv">e</span><span class="tp sp">,</span><span class="tp tv">a</span><span class="tp sp">&gt;</span></span></a>( <a class="pp" href="std_core_delayed.html#delayed_fs_dref">dref<span class="pc"><span class="mo">std<span class="fslash">/</span>core<span class="fslash">/</span>delayed<span class="fslash last">/</span></span><span class="lq">delayed<span class="fslash">/</span></span>dref: <span class="tp kw">forall</span><span class="tp sp">&lt;</span><span class="tp tv">e</span><span class="tp sp">,</span><span class="tp tv">a</span><span class="tp sp">&gt;</span> <span class="tp sp">(</span><span class="tp tpp">delayed</span> <span class="tp kw op">:</span> <span class="tp">delayed</span><span class="tp sp">&lt;</span><span class="tp tv">e</span><span class="tp sp">,</span><span class="tp tv">a</span><span class="tp sp">&gt;</span><span class="tp sp">)</span> <span class="tp kw op">-></span> <span class="tp">ref</span><span class="tp sp">&lt;</span><span class="tp">global</span><span class="tp sp">,</span><span class="tp">either</span><span class="tp sp">&lt;</span><span class="tp sp">(</span><span class="tp sp">)</span> <span class="tp kw op">-></span> <span class="tp tv">e</span> <span class="tp tv">a</span><span class="tp sp">,</span><span class="tp tv">a</span><span class="tp sp">&gt;</span><span class="tp sp">&gt;</span></span></a> <span class="tp kw op">:</span> <a class="pp" href="std_core_types-source.html#type_space_ref"><span class="tp">ref</span><span class="pc"><span class="mo">std<span class="fslash">/</span>core<span class="fslash">/</span>types<span class="fslash last">/</span></span>ref: <span class="tp sp">(</span><span class="co">H</span>, <span class="co">V</span>) <span class="kw op">-></span> <span class="co">V</span></span></a><span class="tp sp">&lt;</span><a class="pp" href="std_core_types-source.html#type_space_global"><span class="tp">global</span><span class="pc"><span class="mo">std<span class="fslash">/</span>core<span class="fslash">/</span>types<span class="fslash last">/</span></span>global: <span class="co">H</span></span></a><span class="tp sp">,</span><a class="pp" href="std_core_types-source.html#type_space_either"><span class="tp">either</span><span class="pc"><span class="mo">std<span class="fslash">/</span>core<span class="fslash">/</span>types<span class="fslash last">/</span></span>either: <span class="tp sp">(</span><span class="co">V</span>, <span class="co">V</span>) <span class="kw op">-></span> <span class="co">V</span></span></a><span class="tp sp">&lt;</span><span class="tp sp">(</span><span class="tp sp">)</span> <span class="tp kw op">-></span> <a class="pp"><span class="tp tv"><span class="effect">e</span></span><span class="pc">e: <span class="co">E</span></span></a> <a class="pp"><span class="tp tv">a</span><span class="pc">a: <span class="co">V</span></span></a><span class="tp sp">,</span><a class="pp"><span class="tp tv">a</span><span class="pc">a: <span class="co">V</span></span></a><span class="tp sp">&gt;</span><span class="tp sp">&gt;</span> </span></span>)

<span class="comment">// Create a new &#96;:delayed&#96; value.
</span><span class="decl-fun" id="delay"><span class="kw">pub</span> <span class="kw">fun</span> <a class="pp" href="std_core_delayed.html#delay">delay<span class="pc"><span class="mo">std<span class="fslash">/</span>core<span class="fslash">/</span>delayed<span class="fslash last">/</span></span>delay: <span class="tp kw">forall</span><span class="tp sp">&lt;</span><span class="tp tv">a</span><span class="tp sp">,</span><span class="tp tv">e</span><span class="tp sp">&gt;</span> <span class="tp sp">(</span><span class="tp tpp">action</span> <span class="tp kw op">:</span> <span class="tp sp">(</span><span class="tp sp">)</span> <span class="tp kw op">-></span> <span class="tp tv">e</span> <span class="tp tv">a</span><span class="tp sp">)</span> <span class="tp kw op">-></span> <span class="tp">delayed</span><span class="tp sp">&lt;</span><span class="tp tv">e</span><span class="tp sp">,</span><span class="tp tv">a</span><span class="tp sp">&gt;</span></span></a>( <a class="pp">action<span class="pc">action: <span class="tp sp">(</span><span class="tp sp">)</span> <span class="tp kw op">-></span> <span class="tp op">$</span><span class="number">125</span> <span class="op">$</span><span class="number">124</span></span></a> <span class="tp kw op">:</span> <span class="tp sp">(</span><span class="tp sp">)</span> <span class="tp kw op">-></span> <a class="pp"><span class="tp tv"><span class="effect">e</span></span><span class="pc">e: <span class="co">E</span></span></a> <a class="pp"><span class="tp tv">a</span><span class="pc">a: <span class="co">V</span></span></a> <a class="pp">)<span class="pc">result: <span class="tp kw op">-></span> <span class="tp">total</span> <span class="tp">delayed</span><span class="tp sp">&lt;</span><span class="number">176</span>,<span class="number">175</span><span class="op">&gt;</span></span></a> <span class="tp kw op">:</span> <a class="pp" href="#type_space_delayed"><span class="tp">delayed</span><span class="pc"><span class="mo">std<span class="fslash">/</span>core<span class="fslash">/</span>delayed<span class="fslash last">/</span></span>delayed: <span class="tp sp">(</span><span class="co">E</span>, <span class="co">V</span>) <span class="kw op">-></span> <span class="co">V</span></span></a><span class="tp sp">&lt;</span><a class="pp"><span class="tp tv"><span class="effect">e</span></span><span class="pc">e: <span class="co">E</span></span></a><span class="tp sp">,</span><a class="pp"><span class="tp tv">a</span><span class="pc">a: <span class="co">V</span></span></a><span class="tp sp">&gt;</span>
  <a class="pp" href="std_core_unsafe-source.html#unsafe_total">unsafe-total<span class="pc"><span class="mo">std<span class="fslash">/</span>core<span class="fslash">/</span>unsafe<span class="fslash last">/</span></span>unsafe<span class="dash">-</span>total: <span class="tp sp">(</span><span class="tp tpp">action</span> <span class="tp kw op">:</span> <span class="tp sp">(</span><span class="tp sp">)</span> <span class="tp kw op">-></span> <span class="tp sp">&lt;</span><span class="tp">alloc</span><span class="tp sp">&lt;</span><span class="tp">global</span><span class="tp sp">&gt;</span><span class="tp kw op">|</span><span class="tp tv">&#95;143</span><span class="tp sp">&gt;</span> <span class="tp">delayed</span><span class="tp op">&lt;$</span><span class="number">125</span>,<span class="op">$</span><span class="number">124</span><span class="op">&gt;</span>) <span class="kw op">-></span> delayed<span class="op">&lt;$</span><span class="number">125</span>,<span class="op">$</span><span class="number">124</span><span class="op">&gt;</span></span></a>
    <span class="kw">val</span> <a class="pp">r<span class="pc">r: <span class="tp">ref</span><span class="tp sp">&lt;</span><span class="tp">global</span><span class="tp sp">,</span><span class="tp">either</span><span class="tp sp">&lt;</span><span class="tp sp">(</span><span class="tp sp">)</span> <span class="tp kw op">-></span> <span class="tp op">$</span><span class="number">125</span> <span class="op">$</span><span class="number">124</span>,<span class="op">$</span><span class="number">124</span><span class="op">&gt;</span><span class="op">&gt;</span></span></a> <span class="tp kw op">:</span> <a class="pp" href="std_core_types-source.html#type_space_ref"><span class="tp">ref</span><span class="pc"><span class="mo">std<span class="fslash">/</span>core<span class="fslash">/</span>types<span class="fslash last">/</span></span>ref: <span class="tp sp">(</span><span class="co">H</span>, <span class="co">V</span>) <span class="kw op">-></span> <span class="co">V</span></span></a><span class="tp sp">&lt;</span><a class="pp" href="std_core_types-source.html#type_space_global"><span class="tp">global</span><span class="pc"><span class="mo">std<span class="fslash">/</span>core<span class="fslash">/</span>types<span class="fslash last">/</span></span>global: <span class="co">H</span></span></a><span class="tp sp">,</span><a class="pp" href="std_core_types-source.html#type_space_either"><span class="tp">either</span><span class="pc"><span class="mo">std<span class="fslash">/</span>core<span class="fslash">/</span>types<span class="fslash last">/</span></span>either: <span class="tp sp">(</span><span class="co">V</span>, <span class="co">V</span>) <span class="kw op">-></span> <span class="co">V</span></span></a><span class="tp sp">&lt;</span><a class="pp"><span class="tp tv">&#95;</span><span class="pc">&#95;w<span class="dash">-</span>l28<span class="dash">-</span>c31: <span class="co">V</span></span></a><span class="tp sp">,</span><a class="pp"><span class="tp tv">&#95;</span><span class="pc">&#95;w<span class="dash">-</span>l28<span class="dash">-</span>c33: <span class="co">V</span></span></a><span class="tp sp">&gt;</span><span class="tp sp">&gt;</span> <span class="kw">=</span> <a class="pp" href="std_core_types-source.html#ref">ref<span class="pc"><span class="mo">std<span class="fslash">/</span>core<span class="fslash">/</span>types<span class="fslash last">/</span></span>ref: <span class="tp sp">(</span><span class="tp tpp">value</span> <span class="tp kw op">:</span> <span class="tp">either</span><span class="tp sp">&lt;</span><span class="tp sp">(</span><span class="tp sp">)</span> <span class="tp kw op">-></span> <span class="tp op">$</span><span class="number">125</span> <span class="op">$</span><span class="number">124</span>,<span class="op">$</span><span class="number">124</span><span class="op">&gt;</span>) <span class="kw op">-></span> <span class="op">&lt;</span>alloc<span class="op">&lt;</span>global<span class="op">&gt;</span><span class="kw op">|</span>&#95;143<span class="op">&gt;</span> ref<span class="op">&lt;</span>global,either<span class="op">&lt;</span>() <span class="kw op">-></span> <span class="op">$</span><span class="number">125</span> <span class="op">$</span><span class="number">124</span>,<span class="op">$</span><span class="number">124</span><span class="op">&gt;</span><span class="op">&gt;</span></span></a>(<a class="pp" href="std_core_types-source.html#con_space_Left"><span class="co">Left</span><span class="pc"><span class="mo">std<span class="fslash">/</span>core<span class="fslash">/</span>types<span class="fslash last">/</span></span>Left: <span class="tp kw">forall</span><span class="tp sp">&lt;</span><span class="tp tv">a</span><span class="tp sp">,</span><span class="tp tv">b</span><span class="tp sp">&gt;</span> <span class="tp sp">(</span><span class="tp tpp">left</span> <span class="tp kw op">:</span> <span class="tp tv">a</span><span class="tp sp">)</span> <span class="tp kw op">-></span> <span class="tp">either</span><span class="tp sp">&lt;</span><span class="tp tv">a</span><span class="tp sp">,</span><span class="tp tv">b</span><span class="tp sp">&gt;</span></span></a>(<a class="pp">action<span class="pc">action: <span class="tp sp">(</span><span class="tp sp">)</span> <span class="tp kw op">-></span> <span class="tp op">$</span><span class="number">125</span> <span class="op">$</span><span class="number">124</span></span></a>))
    <a class="pp" href="#con_space_XDelay"><span class="co">XDelay</span><span class="pc"><span class="mo">std<span class="fslash">/</span>core<span class="fslash">/</span>delayed<span class="fslash last">/</span></span>XDelay: <span class="tp kw">forall</span><span class="tp sp">&lt;</span><span class="tp tv">e</span><span class="tp sp">,</span><span class="tp tv">a</span><span class="tp sp">&gt;</span> <span class="tp sp">(</span><span class="tp tpp">dref</span> <span class="tp kw op">:</span> <span class="tp">ref</span><span class="tp sp">&lt;</span><span class="tp">global</span><span class="tp sp">,</span><span class="tp">either</span><span class="tp sp">&lt;</span><span class="tp sp">(</span><span class="tp sp">)</span> <span class="tp kw op">-></span> <span class="tp tv">e</span> <span class="tp tv">a</span><span class="tp sp">,</span><span class="tp tv">a</span><span class="tp sp">&gt;</span><span class="tp sp">&gt;</span><span class="tp sp">)</span> <span class="tp kw op">-></span> <span class="tp">delayed</span><span class="tp sp">&lt;</span><span class="tp tv">e</span><span class="tp sp">,</span><span class="tp tv">a</span><span class="tp sp">&gt;</span></span></a>(<a class="pp">r<span class="pc">r: <span class="tp">ref</span><span class="tp sp">&lt;</span><span class="tp">global</span><span class="tp sp">,</span><span class="tp">either</span><span class="tp sp">&lt;</span><span class="tp sp">(</span><span class="tp sp">)</span> <span class="tp kw op">-></span> <span class="tp op">$</span><span class="number">125</span> <span class="op">$</span><span class="number">124</span>,<span class="op">$</span><span class="number">124</span><span class="op">&gt;</span><span class="op">&gt;</span></span></a></span>)

<span class="comment">// Force a delayed value; the value is computed only on the first
// call to &#96;force&#96; and cached afterwards.
</span><span class="decl-fun" id="force"><span class="kw">pub</span> <span class="kw">fun</span> <a class="pp" href="std_core_delayed.html#force">force<span class="pc"><span class="mo">std<span class="fslash">/</span>core<span class="fslash">/</span>delayed<span class="fslash last">/</span></span>force: <span class="tp kw">forall</span><span class="tp sp">&lt;</span><span class="tp tv">a</span><span class="tp sp">,</span><span class="tp tv">e</span><span class="tp sp">&gt;</span> <span class="tp sp">(</span><span class="tp tpp">delayed</span> <span class="tp kw op">:</span> <span class="tp">delayed</span><span class="tp sp">&lt;</span><span class="tp tv">e</span><span class="tp sp">,</span><span class="tp tv">a</span><span class="tp sp">&gt;</span><span class="tp sp">)</span> <span class="tp kw op">-></span> <span class="tp tv">e</span> <span class="tp tv">a</span></span></a>( <a class="pp">delayed<span class="pc">delayed: <span class="tp">delayed</span><span class="tp op">&lt;$</span><span class="number">185</span>,<span class="op">$</span><span class="number">184</span><span class="op">&gt;</span></span></a> <span class="tp kw op">:</span> <a class="pp" href="#type_space_delayed"><span class="tp">delayed</span><span class="pc"><span class="mo">std<span class="fslash">/</span>core<span class="fslash">/</span>delayed<span class="fslash last">/</span></span>delayed: <span class="tp sp">(</span><span class="co">E</span>, <span class="co">V</span>) <span class="kw op">-></span> <span class="co">V</span></span></a><span class="tp sp">&lt;</span><a class="pp"><span class="tp tv"><span class="effect">e</span></span><span class="pc">e: <span class="co">E</span></span></a><span class="tp sp">,</span><a class="pp"><span class="tp tv">a</span><span class="pc">a: <span class="co">V</span></span></a><span class="tp sp">&gt;</span> <a class="pp">)<span class="pc">result: <span class="tp kw op">-></span> <span class="number">293</span> <span class="number">292</span></span></a> <span class="tp kw op">:</span> <a class="pp"><span class="tp tv"><span class="effect">e</span></span><span class="pc">e: <span class="co">E</span></span></a> <a class="pp"><span class="tp tv">a</span><span class="pc">a: <span class="co">V</span></span></a>
  <a class="pp" href="std_core_unsafe-source.html#unsafe_total">unsafe-total<span class="pc"><span class="mo">std<span class="fslash">/</span>core<span class="fslash">/</span>unsafe<span class="fslash last">/</span></span>unsafe<span class="dash">-</span>total: <span class="tp sp">(</span><span class="tp tpp">action</span> <span class="tp kw op">:</span> <span class="tp sp">(</span><span class="tp sp">)</span> <span class="tp kw op">-></span> <span class="tp sp">&lt;</span><span class="tp">alloc</span><span class="tp sp">&lt;</span><span class="tp">global</span><span class="tp sp">&gt;</span><span class="tp sp">,</span><span class="tp">div</span><span class="tp sp">,</span><span class="tp">read</span><span class="tp sp">&lt;</span><span class="tp">global</span><span class="tp sp">&gt;</span><span class="tp sp">,</span><span class="tp">write</span><span class="tp sp">&lt;</span><span class="tp">global</span><span class="tp op">&gt;|$</span><span class="number">185</span><span class="op">&gt;</span> <span class="op">$</span><span class="number">184</span>) <span class="kw op">-></span> <span class="op">$</span><span class="number">185</span> <span class="op">$</span><span class="number">184</span></span></a>
    <span class="kw">val</span> <a class="pp">r<span class="pc">r: <span class="tp">ref</span><span class="tp sp">&lt;</span><span class="tp">global</span><span class="tp sp">,</span><span class="tp">either</span><span class="tp sp">&lt;</span><span class="tp sp">(</span><span class="tp sp">)</span> <span class="tp kw op">-></span> <span class="tp op">$</span><span class="number">185</span> <span class="op">$</span><span class="number">184</span>,<span class="op">$</span><span class="number">184</span><span class="op">&gt;</span><span class="op">&gt;</span></span></a> <span class="kw">=</span> <a class="pp">delayed<span class="pc">delayed: <span class="tp">delayed</span><span class="tp op">&lt;$</span><span class="number">185</span>,<span class="op">$</span><span class="number">184</span><span class="op">&gt;</span></span></a><span class="kw op">.</span><a class="pp" href="#delayed_fs_dref">dref<span class="pc"><span class="mo">std<span class="fslash">/</span>core<span class="fslash">/</span>delayed<span class="fslash last">/</span></span><span class="lq">delayed<span class="fslash">/</span></span>dref: <span class="tp sp">(</span><span class="tp tpp">delayed</span> <span class="tp kw op">:</span> <span class="tp">delayed</span><span class="tp op">&lt;$</span><span class="number">185</span>,<span class="op">$</span><span class="number">184</span><span class="op">&gt;</span>) <span class="kw op">-></span> <span class="op">&lt;</span>alloc<span class="op">&lt;</span>global<span class="op">&gt;</span>,div,read<span class="op">&lt;</span>global<span class="op">&gt;</span>,write<span class="op">&lt;</span>global<span class="op">&gt;|$</span><span class="number">185</span><span class="op">&gt;</span> ref<span class="op">&lt;</span>global,either<span class="op">&lt;</span>() <span class="kw op">-></span> <span class="op">$</span><span class="number">185</span> <span class="op">$</span><span class="number">184</span>,<span class="op">$</span><span class="number">184</span><span class="op">&gt;</span><span class="op">&gt;</span></span></a>
    <span class="kw">match</span> <a class="pp" href="std_core_types-source.html#ref_fs__excl_">!<span class="pc"><span class="mo">std<span class="fslash">/</span>core<span class="fslash">/</span>types<span class="fslash last">/</span></span><span class="lq">ref<span class="fslash">/</span></span>(!): <span class="tp sp">(</span><span class="tp tpp">ref</span> <span class="tp kw op">:</span> <span class="tp">ref</span><span class="tp sp">&lt;</span><span class="tp">global</span><span class="tp sp">,</span><span class="tp">either</span><span class="tp sp">&lt;</span><span class="tp sp">(</span><span class="tp sp">)</span> <span class="tp kw op">-></span> <span class="tp op">$</span><span class="number">185</span> <span class="op">$</span><span class="number">184</span>,<span class="op">$</span><span class="number">184</span><span class="op">&gt;</span><span class="op">&gt;</span>) <span class="kw op">-></span> <span class="op">&lt;</span>read<span class="op">&lt;</span>global<span class="op">&gt;</span>,div,alloc<span class="op">&lt;</span>global<span class="op">&gt;</span>,write<span class="op">&lt;</span>global<span class="op">&gt;|$</span><span class="number">185</span><span class="op">&gt;</span> either<span class="op">&lt;</span>() <span class="kw op">-></span> <span class="op">$</span><span class="number">185</span> <span class="op">$</span><span class="number">184</span>,<span class="op">$</span><span class="number">184</span><span class="op">&gt;</span></span></a><a class="pp">r<span class="pc">r: <span class="tp">ref</span><span class="tp sp">&lt;</span><span class="tp">global</span><span class="tp sp">,</span><span class="tp">either</span><span class="tp sp">&lt;</span><span class="tp sp">(</span><span class="tp sp">)</span> <span class="tp kw op">-></span> <span class="tp op">$</span><span class="number">185</span> <span class="op">$</span><span class="number">184</span>,<span class="op">$</span><span class="number">184</span><span class="op">&gt;</span><span class="op">&gt;</span></span></a>
      <a class="pp" href="std_core_types-source.html#con_space_Right"><span class="co">Right</span><span class="pc"><span class="mo">std<span class="fslash">/</span>core<span class="fslash">/</span>types<span class="fslash last">/</span></span>Right: <span class="tp kw">forall</span><span class="tp sp">&lt;</span><span class="tp tv">a</span><span class="tp sp">,</span><span class="tp tv">b</span><span class="tp sp">&gt;</span> <span class="tp sp">(</span><span class="tp tpp">right</span> <span class="tp kw op">:</span> <span class="tp tv">b</span><span class="tp sp">)</span> <span class="tp kw op">-></span> <span class="tp">either</span><span class="tp sp">&lt;</span><span class="tp tv">a</span><span class="tp sp">,</span><span class="tp tv">b</span><span class="tp sp">&gt;</span></span></a>(<a class="pp">x<span class="pc">x: <span class="tp op">$</span><span class="number">184</span></span></a>) <span class="kw op">-></span> <a class="pp">x<span class="pc">x: <span class="tp op">$</span><span class="number">184</span></span></a>
      <a class="pp" href="std_core_types-source.html#con_space_Left"><span class="co">Left</span><span class="pc"><span class="mo">std<span class="fslash">/</span>core<span class="fslash">/</span>types<span class="fslash last">/</span></span>Left: <span class="tp kw">forall</span><span class="tp sp">&lt;</span><span class="tp tv">a</span><span class="tp sp">,</span><span class="tp tv">b</span><span class="tp sp">&gt;</span> <span class="tp sp">(</span><span class="tp tpp">left</span> <span class="tp kw op">:</span> <span class="tp tv">a</span><span class="tp sp">)</span> <span class="tp kw op">-></span> <span class="tp">either</span><span class="tp sp">&lt;</span><span class="tp tv">a</span><span class="tp sp">,</span><span class="tp tv">b</span><span class="tp sp">&gt;</span></span></a>(<a class="pp">action<span class="pc">action: <span class="tp sp">(</span><span class="tp sp">)</span> <span class="tp kw op">-></span> <span class="tp op">$</span><span class="number">185</span> <span class="op">$</span><span class="number">184</span></span></a>) <span class="kw op">-></span>
        <span class="kw">val</span> <a class="pp">x<span class="pc">x: <span class="tp op">$</span><span class="number">184</span></span></a> <span class="kw">=</span> <a class="pp" href="std_core_types-source.html#mask_st">mask-st<span class="pc"><span class="mo">std<span class="fslash">/</span>core<span class="fslash">/</span>types<span class="fslash last">/</span></span>mask<span class="dash">-</span>st: <span class="tp sp">(</span><span class="tp sp">(</span><span class="tp sp">)</span> <span class="tp kw op">-></span> <span class="tp sp">&lt;</span><span class="tp">div</span><span class="tp op">|$</span><span class="number">185</span><span class="op">&gt;</span> <span class="op">$</span><span class="number">184</span>) <span class="kw op">-></span> <span class="op">&lt;</span>alloc<span class="op">&lt;</span>global<span class="op">&gt;</span>,div,read<span class="op">&lt;</span>global<span class="op">&gt;</span>,write<span class="op">&lt;</span>global<span class="op">&gt;|$</span><span class="number">185</span><span class="op">&gt;</span> (() <span class="kw op">-></span> <span class="op">&lt;</span>st<span class="op">&lt;</span>global<span class="op">&gt;</span>,div<span class="op">|$</span><span class="number">185</span><span class="op">&gt;</span> <span class="op">$</span><span class="number">184</span>)</span></a>{ <span class="kw">mask</span><span class="op">&lt;</span><a class="pp" href="std_core_types-source.html#type_space_div"><span class="tp"><span class="effect">div</span></span><span class="pc"><span class="mo">std<span class="fslash">/</span>core<span class="fslash">/</span>types<span class="fslash last">/</span></span>div: <span class="co">X</span></span></a><span class="op">&gt;</span>(<a class="pp">action<span class="pc">action: <span class="tp sp">(</span><span class="tp sp">)</span> <span class="tp kw op">-></span> <span class="tp op">$</span><span class="number">185</span> <span class="op">$</span><span class="number">184</span></span></a>) }()
        <a class="pp">r<span class="pc">r: <span class="tp">ref</span><span class="tp sp">&lt;</span><span class="tp">global</span><span class="tp sp">,</span><span class="tp">either</span><span class="tp sp">&lt;</span><span class="tp sp">(</span><span class="tp sp">)</span> <span class="tp kw op">-></span> <span class="tp op">$</span><span class="number">185</span> <span class="op">$</span><span class="number">184</span>,<span class="op">$</span><span class="number">184</span><span class="op">&gt;</span><span class="op">&gt;</span></span></a> <a class="pp" href="std_core_types-source.html#set"><span class="kw">:=</span><span class="pc"><span class="mo">std<span class="fslash">/</span>core<span class="fslash">/</span>types<span class="fslash last">/</span></span>set: <span class="tp sp">(</span><span class="tp tpp">ref</span> <span class="tp kw op">:</span> <span class="tp">ref</span><span class="tp sp">&lt;</span><span class="tp">global</span><span class="tp sp">,</span><span class="tp">either</span><span class="tp sp">&lt;</span><span class="tp sp">(</span><span class="tp sp">)</span> <span class="tp kw op">-></span> <span class="tp op">$</span><span class="number">185</span> <span class="op">$</span><span class="number">184</span>,<span class="op">$</span><span class="number">184</span><span class="op">&gt;</span><span class="op">&gt;</span>, assigned <span class="tp kw op">:</span> <span class="tp">either</span><span class="tp sp">&lt;</span><span class="tp sp">(</span><span class="tp sp">)</span> <span class="tp kw op">-></span> <span class="tp op">$</span><span class="number">185</span> <span class="op">$</span><span class="number">184</span>,<span class="op">$</span><span class="number">184</span><span class="op">&gt;</span>) <span class="kw op">-></span> <span class="op">&lt;</span>write<span class="op">&lt;</span>global<span class="op">&gt;</span>,alloc<span class="op">&lt;</span>&#95;245<span class="op">&gt;</span>,div,read<span class="op">&lt;</span>&#95;245<span class="op">&gt;|$</span><span class="number">185</span><span class="op">&gt;</span> ()</span></a> <a class="pp" href="std_core_types-source.html#con_space_Right"><span class="co">Right</span><span class="pc"><span class="mo">std<span class="fslash">/</span>core<span class="fslash">/</span>types<span class="fslash last">/</span></span>Right: <span class="tp kw">forall</span><span class="tp sp">&lt;</span><span class="tp tv">a</span><span class="tp sp">,</span><span class="tp tv">b</span><span class="tp sp">&gt;</span> <span class="tp sp">(</span><span class="tp tpp">right</span> <span class="tp kw op">:</span> <span class="tp tv">b</span><span class="tp sp">)</span> <span class="tp kw op">-></span> <span class="tp">either</span><span class="tp sp">&lt;</span><span class="tp tv">a</span><span class="tp sp">,</span><span class="tp tv">b</span><span class="tp sp">&gt;</span></span></a>(<a class="pp">x<span class="pc">x: <span class="tp op">$</span><span class="number">184</span></span></a>)
        </span><a class="pp">x<span class="pc">x: <span class="tp op">$</span><span class="number">184</span></span></a>

<span class="comment">// Given a total function to calculate a value &#96;:a&#96;, return
// a total function that only calculates the value once and then
// returns the cached result.
</span><span class="decl-fun" id="once"><span class="kw">pub</span> <span class="kw">fun</span> <a class="pp" href="std_core_delayed.html#once">once<span class="pc"><span class="mo">std<span class="fslash">/</span>core<span class="fslash">/</span>delayed<span class="fslash last">/</span></span>once: <span class="tp kw">forall</span><span class="tp sp">&lt;</span><span class="tp tv">a</span><span class="tp sp">&gt;</span> <span class="tp sp">(</span><span class="tp tpp">calc</span> <span class="tp kw op">:</span> <span class="tp sp">(</span><span class="tp sp">)</span> <span class="tp kw op">-></span> <span class="tp tv">a</span><span class="tp sp">)</span> <span class="tp kw op">-></span> <span class="tp sp">(</span><span class="tp sp">(</span><span class="tp sp">)</span> <span class="tp kw op">-></span> <span class="tp tv">a</span><span class="tp sp">)</span></span></a>( <a class="pp">calc<span class="pc">calc: <span class="tp sp">(</span><span class="tp sp">)</span> <span class="tp kw op">-></span> <span class="tp op">$</span><span class="number">300</span></span></a> <span class="tp kw op">:</span> <span class="tp sp">(</span><span class="tp sp">)</span> <span class="tp kw op">-></span> <a class="pp" href="std_core_types-source.html#type_space_total"><span class="tp"><span class="effect">a</span></span><span class="pc"><span class="mo">std<span class="fslash">/</span>core<span class="fslash">/</span>types<span class="fslash last">/</span></span>total: <span class="co">E</span></span></a> <a class="pp">)<span class="pc">result: <span class="tp kw op">-></span> <span class="tp">total</span> <span class="tp sp">(</span><span class="tp sp">)</span> <span class="tp kw op">-></span> <span class="number">396</span></span></a> <span class="tp kw op">:</span> <span class="tp sp">(</span><a class="pp" href="std_core_types-source.html#type_space_total"><span class="tp"><span class="effect">(</span></span><span class="pc"><span class="mo">std<span class="fslash">/</span>core<span class="fslash">/</span>types<span class="fslash last">/</span></span>total: <span class="co">E</span></span></a><span class="tp sp">)</span> <span class="tp kw op">-></span> <a class="pp" href="std_core_types-source.html#type_space_total"><span class="tp"><span class="effect">a</span></span><span class="pc"><span class="mo">std<span class="fslash">/</span>core<span class="fslash">/</span>types<span class="fslash last">/</span></span>total: <span class="co">E</span></span></a><span class="tp sp">)</span>
  <a class="pp" href="std_core_unsafe-source.html#unsafe_total">unsafe-total<span class="pc"><span class="mo">std<span class="fslash">/</span>core<span class="fslash">/</span>unsafe<span class="fslash last">/</span></span>unsafe<span class="dash">-</span>total: <span class="tp sp">(</span><span class="tp tpp">action</span> <span class="tp kw op">:</span> <span class="tp sp">(</span><span class="tp sp">)</span> <span class="tp kw op">-></span> <span class="tp sp">&lt;</span><span class="tp">alloc</span><span class="tp sp">&lt;</span><span class="tp tv">&#95;318</span><span class="tp sp">&gt;</span><span class="tp kw op">|</span><span class="tp tv">&#95;319</span><span class="tp sp">&gt;</span> <span class="tp sp">(</span><span class="tp sp">(</span><span class="tp sp">)</span> <span class="tp kw op">-></span> <span class="tp op">$</span><span class="number">300</span>)) <span class="kw op">-></span> (() <span class="kw op">-></span> <span class="op">$</span><span class="number">300</span>)</span></a>
    <span class="kw">val</span> <a class="pp">r<span class="pc">r: <span class="tp">ref</span><span class="tp sp">&lt;</span><span class="tp tv">&#95;318</span><span class="tp sp">,</span><span class="tp">maybe</span><span class="tp op">&lt;$</span><span class="number">300</span><span class="op">&gt;</span><span class="op">&gt;</span></span></a> <span class="kw">=</span> <a class="pp" href="std_core_types-source.html#ref">ref<span class="pc"><span class="mo">std<span class="fslash">/</span>core<span class="fslash">/</span>types<span class="fslash last">/</span></span>ref: <span class="tp sp">(</span><span class="tp tpp">value</span> <span class="tp kw op">:</span> <span class="tp">maybe</span><span class="tp op">&lt;$</span><span class="number">300</span><span class="op">&gt;</span>) <span class="kw op">-></span> <span class="op">&lt;</span>alloc<span class="op">&lt;</span>&#95;318<span class="op">&gt;</span><span class="kw op">|</span>&#95;319<span class="op">&gt;</span> ref<span class="op">&lt;</span>&#95;318,maybe<span class="op">&lt;$</span><span class="number">300</span><span class="op">&gt;</span><span class="op">&gt;</span></span></a>(<a class="pp" href="std_core_types-source.html#con_space_Nothing"><span class="co">Nothing</span><span class="pc"><span class="mo">std<span class="fslash">/</span>core<span class="fslash">/</span>types<span class="fslash last">/</span></span>Nothing: <span class="tp kw">forall</span><span class="tp sp">&lt;</span><span class="tp tv">a</span><span class="tp sp">&gt;</span> <span class="tp">maybe</span><span class="tp sp">&lt;</span><span class="tp tv">a</span><span class="tp sp">&gt;</span></span></a>)
    <a class="pp"><span class="kw">return</span><span class="pc">return: <span class="tp sp">(</span><span class="tp sp">)</span> <span class="tp kw op">-></span> <span class="tp op">$</span><span class="number">300</span></span></a> <a class="pp"><span class="kw">fn</span><span class="pc">fn: <span class="tp sp">(</span><span class="tp sp">)</span> <span class="tp kw op">-></span> <span class="tp op">$</span><span class="number">300</span></span></a>()
      <a class="pp" href="std_core_unsafe-source.html#unsafe_total">unsafe-total<span class="pc"><span class="mo">std<span class="fslash">/</span>core<span class="fslash">/</span>unsafe<span class="fslash last">/</span></span>unsafe<span class="dash">-</span>total: <span class="tp sp">(</span><span class="tp tpp">action</span> <span class="tp kw op">:</span> <span class="tp sp">(</span><span class="tp sp">)</span> <span class="tp kw op">-></span> <span class="tp sp">&lt;</span><span class="tp">read</span><span class="tp sp">&lt;</span><span class="tp tv">&#95;318</span><span class="tp sp">&gt;</span><span class="tp sp">,</span><span class="tp">write</span><span class="tp sp">&lt;</span><span class="tp tv">&#95;318</span><span class="tp sp">&gt;</span><span class="tp sp">,</span><span class="tp">div</span><span class="tp kw op">|</span><span class="tp tv">&#95;388</span><span class="tp sp">&gt;</span> <span class="tp op">$</span><span class="number">300</span>) <span class="kw op">-></span> <span class="op">$</span><span class="number">300</span></span></a>
        <span class="kw">match</span> <a class="pp" href="std_core_types-source.html#ref_fs__excl_">!<span class="pc"><span class="mo">std<span class="fslash">/</span>core<span class="fslash">/</span>types<span class="fslash last">/</span></span><span class="lq">ref<span class="fslash">/</span></span>(!): <span class="tp sp">(</span><span class="tp tpp">ref</span> <span class="tp kw op">:</span> <span class="tp">ref</span><span class="tp sp">&lt;</span><span class="tp tv">&#95;318</span><span class="tp sp">,</span><span class="tp">maybe</span><span class="tp op">&lt;$</span><span class="number">300</span><span class="op">&gt;</span><span class="op">&gt;</span>) <span class="kw op">-></span> <span class="op">&lt;</span>read<span class="op">&lt;</span>&#95;318<span class="op">&gt;</span>,write<span class="op">&lt;</span>&#95;318<span class="op">&gt;</span>,div<span class="kw op">|</span>&#95;388<span class="op">&gt;</span> maybe<span class="op">&lt;$</span><span class="number">300</span><span class="op">&gt;</span></span></a><a class="pp">r<span class="pc">r: <span class="tp">ref</span><span class="tp sp">&lt;</span><span class="tp tv">&#95;318</span><span class="tp sp">,</span><span class="tp">maybe</span><span class="tp op">&lt;$</span><span class="number">300</span><span class="op">&gt;</span><span class="op">&gt;</span></span></a>
          <a class="pp" href="std_core_types-source.html#con_space_Just"><span class="co">Just</span><span class="pc"><span class="mo">std<span class="fslash">/</span>core<span class="fslash">/</span>types<span class="fslash last">/</span></span>Just: <span class="tp kw">forall</span><span class="tp sp">&lt;</span><span class="tp tv">a</span><span class="tp sp">&gt;</span> <span class="tp sp">(</span><span class="tp tpp">value</span> <span class="tp kw op">:</span> <span class="tp tv">a</span><span class="tp sp">)</span> <span class="tp kw op">-></span> <span class="tp">maybe</span><span class="tp sp">&lt;</span><span class="tp tv">a</span><span class="tp sp">&gt;</span></span></a>(<a class="pp">x<span class="pc">x: <span class="tp op">$</span><span class="number">300</span></span></a>) <span class="kw op">-></span> <a class="pp">x<span class="pc">x: <span class="tp op">$</span><span class="number">300</span></span></a>
          <a class="pp" href="std_core_types-source.html#con_space_Nothing"><span class="co">Nothing</span><span class="pc"><span class="mo">std<span class="fslash">/</span>core<span class="fslash">/</span>types<span class="fslash last">/</span></span>Nothing: <span class="tp kw">forall</span><span class="tp sp">&lt;</span><span class="tp tv">a</span><span class="tp sp">&gt;</span> <span class="tp">maybe</span><span class="tp sp">&lt;</span><span class="tp tv">a</span><span class="tp sp">&gt;</span></span></a> <span class="kw op">-></span>
            <span class="kw">val</span> <a class="pp">x<span class="pc">x: <span class="tp op">$</span><span class="number">300</span></span></a> <span class="kw">=</span> <a class="pp">calc<span class="pc">calc: <span class="tp sp">(</span><span class="tp sp">)</span> <span class="tp kw op">-></span> <span class="tp sp">&lt;</span><span class="tp">write</span><span class="tp sp">&lt;</span><span class="tp tv">&#95;318</span><span class="tp sp">&gt;</span><span class="tp sp">,</span><span class="tp">read</span><span class="tp sp">&lt;</span><span class="tp tv">&#95;318</span><span class="tp sp">&gt;</span><span class="tp sp">,</span><span class="tp">div</span><span class="tp kw op">|</span><span class="tp tv">&#95;388</span><span class="tp sp">&gt;</span> <span class="tp op">$</span><span class="number">300</span></span></a>()
            <a class="pp">r<span class="pc">r: <span class="tp">ref</span><span class="tp sp">&lt;</span><span class="tp tv">&#95;318</span><span class="tp sp">,</span><span class="tp">maybe</span><span class="tp op">&lt;$</span><span class="number">300</span><span class="op">&gt;</span><span class="op">&gt;</span></span></a> <a class="pp" href="std_core_types-source.html#set"><span class="kw">:=</span><span class="pc"><span class="mo">std<span class="fslash">/</span>core<span class="fslash">/</span>types<span class="fslash last">/</span></span>set: <span class="tp sp">(</span><span class="tp tpp">ref</span> <span class="tp kw op">:</span> <span class="tp">ref</span><span class="tp sp">&lt;</span><span class="tp tv">&#95;318</span><span class="tp sp">,</span><span class="tp">maybe</span><span class="tp op">&lt;$</span><span class="number">300</span><span class="op">&gt;</span><span class="op">&gt;</span>, assigned <span class="tp kw op">:</span> <span class="tp">maybe</span><span class="tp op">&lt;$</span><span class="number">300</span><span class="op">&gt;</span>) <span class="kw op">-></span> <span class="op">&lt;</span>write<span class="op">&lt;</span>&#95;318<span class="op">&gt;</span>,read<span class="op">&lt;</span>&#95;318<span class="op">&gt;</span>,div<span class="kw op">|</span>&#95;388<span class="op">&gt;</span> ()</span></a> <a class="pp" href="std_core_types-source.html#con_space_Just"><span class="co">Just</span><span class="pc"><span class="mo">std<span class="fslash">/</span>core<span class="fslash">/</span>types<span class="fslash last">/</span></span>Just: <span class="tp kw">forall</span><span class="tp sp">&lt;</span><span class="tp tv">a</span><span class="tp sp">&gt;</span> <span class="tp sp">(</span><span class="tp tpp">value</span> <span class="tp kw op">:</span> <span class="tp tv">a</span><span class="tp sp">)</span> <span class="tp kw op">-></span> <span class="tp">maybe</span><span class="tp sp">&lt;</span><span class="tp tv">a</span><span class="tp sp">&gt;</span></span></a>(<a class="pp">x<span class="pc">x: <span class="tp op">$</span><span class="number">300</span></span></a>)
            </span><a class="pp">x<span class="pc">x: <span class="tp op">$</span><span class="number">300</span></span></a>
</pre>

</body>
</html>
